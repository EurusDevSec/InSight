name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ===== BACKEND JAVA =====
  backend-java:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check if Java project exists
        id: check-java
        run: |
          if [ -f "backend/api-gateway/pom.xml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Java backend not initialized yet. Skipping build."
          fi

      - name: Set up JDK 21
        if: steps.check-java.outputs.exists == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Build with Maven
        if: steps.check-java.outputs.exists == 'true'
        run: |
          cd backend/api-gateway
          mvn clean verify -DskipTests

  # ===== BACKEND PYTHON =====
  backend-python:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -d "backend/vision-service" ] && [ -f "backend/vision-service/requirements.txt" ]; then
            cd backend/vision-service
            pip install -r requirements.txt
            pip install pytest
            
            if [ -d "tests" ]; then
                pytest tests/
            else
                echo "No tests found in vision-service"
            fi
          else
            echo "Python backend (vision-service) not initialized or missing requirements.txt. Skipping."
          fi

  # ===== MOBILE FLUTTER =====
  mobile:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.16.0"
          channel: "stable"

      - name: Check Flutter
        run: |
          if [ -d "mobile/insight_app" ] && [ -f "mobile/insight_app/pubspec.yaml" ]; then
            cd mobile/insight_app
            flutter pub get
            flutter analyze
          else
             echo "Mobile app (insight_app) not initialized or missing pubspec.yaml. Skipping."
          fi

  # ===== DOCKER COMPOSE =====
  docker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose
        run: docker compose config
