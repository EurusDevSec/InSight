name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ===== BACKEND JAVA =====
  backend-java:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/api-gateway

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Build with Maven
        run: |
          if [ -f pom.xml ]; then
            mvn clean verify -DskipTests
          else
            echo "No pom.xml found, skipping Java build"
          fi

  # ===== BACKEND PYTHON =====
  backend-python:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/vision-service

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            pip install pytest
          else
            echo "No requirements.txt found, skipping Python setup"
          fi

      - name: Run tests
        run: |
          if [ -d tests ]; then
            pytest tests/
          else
            echo "No tests found, skipping"
          fi

  # ===== MOBILE FLUTTER =====
  mobile:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile/insight_app

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.16.0"
          channel: "stable"

      - name: Check Flutter
        run: |
          if [ -f pubspec.yaml ]; then
            flutter pub get
            flutter analyze
          else
            echo "No pubspec.yaml found, skipping Flutter build"
          fi

  # ===== DOCKER COMPOSE =====
  docker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose
        run: docker compose config
